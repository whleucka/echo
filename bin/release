#!/usr/bin/env bash

set -euo pipefail

VERSION_FILE="$(dirname "$0")/../src/Framework/VERSION"

if [ $# -ne 1 ]; then
    echo "Usage: bin/release <version>"
    echo "Example: bin/release v0.4.1"
    exit 1
fi

VERSION="$1"

# Validate semver format (vX.Y.Z)
if ! [[ "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "Error: Version must be in format vX.Y.Z (e.g. v0.4.1)"
    exit 1
fi

# Check for uncommitted changes
if ! git diff --quiet || ! git diff --cached --quiet; then
    echo "Error: You have uncommitted changes. Commit or stash them first."
    exit 1
fi

# Check if tag already exists
if git rev-parse "$VERSION" >/dev/null 2>&1; then
    echo "Error: Tag $VERSION already exists."
    exit 1
fi

# Update VERSION file
echo "$VERSION" > "$VERSION_FILE"

# Commit and tag
git add "$VERSION_FILE"
git commit -m "release: $VERSION"
git tag "$VERSION"

echo "Released $VERSION"
echo "Run 'git push && git push --tags' to publish."
