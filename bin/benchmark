#!/bin/bash

# Echo Framework Benchmark Script
# Usage: ./bin/benchmark [base_url] [duration] [connections]

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# Configuration
BASE_URL="${1:-http://localhost}"
DURATION="${2:-10}"
CONNECTIONS="${3:-100}"
THREADS=4

# Detect available tool
BENCH_TOOL=""
if command -v wrk &> /dev/null; then
    BENCH_TOOL="wrk"
elif command -v ab &> /dev/null; then
    BENCH_TOOL="ab"
else
    BENCH_TOOL="curl"
    echo -e "${YELLOW}Note: Using curl (install 'wrk' or 'ab' for more accurate results)${NC}"
fi

echo -e "${BOLD}${CYAN}"
echo "╔═══════════════════════════════════════════════════════════════╗"
echo "║           Echo Framework Performance Benchmark                ║"
echo "╚═══════════════════════════════════════════════════════════════╝"
echo -e "${NC}"

echo -e "${BLUE}Configuration:${NC}"
echo "  Base URL:    $BASE_URL"
echo "  Tool:        $BENCH_TOOL"
echo "  Duration:    ${DURATION}s"
echo "  Connections: $CONNECTIONS"
echo ""

# Endpoints to test
declare -a ENDPOINTS=(
    "/benchmark/plaintext:Plaintext (raw overhead)"
    "/benchmark/json:JSON Serialization"
    "/benchmark/db:Single DB Query"
    "/benchmark/template:Template Rendering"
    "/benchmark/fullstack:Full Stack (DB + Template)"
)

# Results storage
declare -A RESULTS

run_wrk() {
    local url="$1"
    local name="$2"

    echo -e "${YELLOW}Running: ${name}${NC}"
    echo -e "${CYAN}  URL: ${url}${NC}"

    result=$(wrk -t$THREADS -c$CONNECTIONS -d${DURATION}s "$url" 2>&1)

    # Extract metrics
    rps=$(echo "$result" | grep "Requests/sec" | awk '{print $2}')
    latency_avg=$(echo "$result" | grep "Latency" | awk '{print $2}')
    latency_max=$(echo "$result" | grep "Latency" | awk '{print $4}')
    transfer=$(echo "$result" | grep "Transfer/sec" | awk '{print $2}')

    echo -e "  ${GREEN}Requests/sec:${NC} $rps"
    echo -e "  ${GREEN}Latency (avg):${NC} $latency_avg"
    echo -e "  ${GREEN}Latency (max):${NC} $latency_max"
    echo -e "  ${GREEN}Transfer/sec:${NC} $transfer"
    echo ""

    RESULTS["$name"]="$rps"
}

run_ab() {
    local url="$1"
    local name="$2"
    local requests=$((CONNECTIONS * DURATION))

    echo -e "${YELLOW}Running: ${name}${NC}"
    echo -e "${CYAN}  URL: ${url}${NC}"

    result=$(ab -n $requests -c $CONNECTIONS -q "$url" 2>&1)

    # Extract metrics
    rps=$(echo "$result" | grep "Requests per second" | awk '{print $4}')
    latency_avg=$(echo "$result" | grep "Time per request" | head -1 | awk '{print $4}')
    transfer=$(echo "$result" | grep "Transfer rate" | awk '{print $3}')

    echo -e "  ${GREEN}Requests/sec:${NC} $rps"
    echo -e "  ${GREEN}Time/request:${NC} ${latency_avg}ms"
    echo -e "  ${GREEN}Transfer rate:${NC} ${transfer} KB/sec"
    echo ""

    RESULTS["$name"]="$rps"
}

run_curl() {
    local url="$1"
    local name="$2"
    local iterations=100

    echo -e "${YELLOW}Running: ${name}${NC}"
    echo -e "${CYAN}  URL: ${url}${NC}"

    # Run iterations and collect times
    local times=()
    local success=0

    for ((i=1; i<=iterations; i++)); do
        time_s=$(curl -s -o /dev/null -w "%{time_total}" "$url")
        if [ $? -eq 0 ]; then
            times+=("$time_s")
            success=$((success + 1))
        fi
    done

    if [ $success -gt 0 ]; then
        # Calculate stats using awk
        stats=$(printf '%s\n' "${times[@]}" | awk '
            BEGIN { min=999; max=0; sum=0; count=0 }
            {
                t = $1 * 1000  # convert to ms
                sum += t
                count++
                if (t < min) min = t
                if (t > max) max = t
            }
            END {
                avg = sum / count
                rps = 1000 / avg
                printf "%.2f %.2f %.2f %.1f", avg, min, max, rps
            }
        ')
        read avg_time min_time max_time rps <<< "$stats"

        echo -e "  ${GREEN}Requests/sec:${NC} ~${rps} (estimated from ${iterations} sequential requests)"
        echo -e "  ${GREEN}Latency (avg):${NC} ${avg_time}ms"
        echo -e "  ${GREEN}Latency (min):${NC} ${min_time}ms"
        echo -e "  ${GREEN}Latency (max):${NC} ${max_time}ms"

        RESULTS["$name"]="~$rps"
    else
        echo -e "  ${RED}All requests failed${NC}"
        RESULTS["$name"]="FAILED"
    fi
    echo ""
}

# Warm up
echo -e "${BLUE}Warming up...${NC}"
curl -s "${BASE_URL}/benchmark/plaintext" > /dev/null 2>&1 || {
    echo -e "${RED}Error: Cannot reach ${BASE_URL}/benchmark/plaintext${NC}"
    echo "Make sure the server is running and the URL is correct."
    exit 1
}
echo -e "${GREEN}Server is responding.${NC}"
echo ""

# Run benchmarks
echo -e "${BOLD}${BLUE}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${BOLD}${BLUE}                     Running Benchmarks                        ${NC}"
echo -e "${BOLD}${BLUE}═══════════════════════════════════════════════════════════════${NC}"
echo ""

for endpoint_data in "${ENDPOINTS[@]}"; do
    IFS=':' read -r endpoint name <<< "$endpoint_data"
    url="${BASE_URL}${endpoint}"

    if [ "$BENCH_TOOL" = "wrk" ]; then
        run_wrk "$url" "$name"
    elif [ "$BENCH_TOOL" = "ab" ]; then
        run_ab "$url" "$name"
    else
        run_curl "$url" "$name"
    fi
done

# Memory check
echo -e "${YELLOW}Checking memory usage...${NC}"
memory_result=$(curl -s "${BASE_URL}/benchmark/memory")
echo -e "${GREEN}Memory Usage:${NC} $(echo $memory_result | grep -o '"memory_usage_formatted":"[^"]*"' | cut -d'"' -f4)"
echo -e "${GREEN}Peak Memory:${NC} $(echo $memory_result | grep -o '"memory_peak_formatted":"[^"]*"' | cut -d'"' -f4)"
echo ""

# Summary
echo -e "${BOLD}${CYAN}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${BOLD}${CYAN}                         Summary                               ${NC}"
echo -e "${BOLD}${CYAN}═══════════════════════════════════════════════════════════════${NC}"
echo ""
printf "${BOLD}%-30s %15s${NC}\n" "Test" "Requests/sec"
echo "─────────────────────────────────────────────────"
for name in "Plaintext (raw overhead)" "JSON Serialization" "Single DB Query" "Template Rendering" "Full Stack (DB + Template)"; do
    rps="${RESULTS[$name]:-N/A}"
    printf "%-30s %15s\n" "$name" "$rps"
done
echo ""

echo -e "${BOLD}${GREEN}Benchmark complete!${NC}"
echo ""
echo "Tips for comparison:"
echo "  - Run the same tests against Laravel, Slim, etc."
echo "  - Use the same hardware and database"
echo "  - Run multiple times and average results"
echo "  - Consider submitting to TechEmpower benchmarks"
