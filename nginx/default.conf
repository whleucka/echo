upstream php-fpm {
  server php:9000;
  keepalive 16;
}

server {
  listen 80;
  # Accept all subdomains and localhost for development
  server_name localhost *.localhost;

  set_real_ip_from 127.0.0.1;
  set_real_ip_from 172.18.0.0/16;
  real_ip_header X-Forwarded-For;
  real_ip_recursive on;

  client_max_body_size 32m;

  root /var/www/html/public;
  index index.php index.html;

  # Gzip compression (level 4 â€” good ratio, low CPU for shared VPS)
  gzip on;
  gzip_vary on;
  gzip_proxied any;
  gzip_comp_level 4;
  gzip_min_length 256;
  gzip_types
    text/plain
    text/css
    text/javascript
    application/javascript
    application/json
    application/xml
    image/svg+xml
    font/woff2;

  # Security headers
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;

  location / {
    try_files $uri $uri/ /index.php?$query_string;
  }

  # Static asset caching
  location ~* \.(?:css|js)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    access_log off;
  }

  location ~* \.(?:woff2?|ttf|otf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    access_log off;
  }

  location ~* \.(?:jpg|jpeg|png|gif|webp|avif|ico|svg)$ {
    expires 30d;
    add_header Cache-Control "public";
    access_log off;
  }

  location ~ \.php$ {
    include fastcgi_params;
    fastcgi_pass php-fpm;
    fastcgi_keep_conn on;
    fastcgi_index index.php;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param PATH_INFO $fastcgi_path_info;
    # Pass the Host header to PHP so subdomain routing works
    fastcgi_param HTTP_HOST $host;

    # Buffer tuning and timeouts (match PHP's 30s max_execution_time)
    fastcgi_buffer_size 16k;
    fastcgi_buffers 8 16k;
    fastcgi_connect_timeout 10s;
    fastcgi_send_timeout 30s;
    fastcgi_read_timeout 30s;
  }

  # Deny access to all dotfiles (.env, .git, .htaccess, etc.)
  location ~ /\. {
    deny all;
  }
}
