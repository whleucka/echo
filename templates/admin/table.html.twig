<div class="mb-2">
  {% include "components/flash.html.twig" %}
</div>
<div id="table" class="card shad border-0">
  <div class="card-body p-2">
  <div id="table-actions" class="p-2 d-flex align-items-center flex-wrap">
    <form class="d-flex align-items-center flex-wrap">
      {{ csrf()|raw }}
      {% for action in toolbarActions %}
        {% if action.name == 'create' and isToolbarActionAllowed('create') %}
          <button class="btn btn-sm btn-success me-2" hx-on::after-request="new bootstrap.Modal(document.getElementById('modal')).show()" hx-get="/admin/{{ module.link }}/modal/create" hx-target=".modal-dialog" hx-select=".modal-content"><i class="bi {{ action.icon }} pe-1"></i> {{ action.label }}</button>
        {% endif %}
      {% endfor %}
      {% for link in filters.filterLinks.links %}
        <button hx-get="/admin/{{ module.link }}/filter/link/{{ loop.index0 }}" hx-swap="outerHTML" hx-target="#table" hx-select="#table" class="btn btn-primary btn-sm text-light filter-link {% if filters.filterLinks.active == loop.index0 %}active{% endif %} me-2">
          <i class="bi bi-filter-circle me-1"></i> {{ link }} <span class="link-count badge bg-light text-dark ms-2">--</span>
        </button>
        <span hx-get="/admin/{{ module.link }}/filter/count/{{ loop.index0 }}" hx-trigger="load" hx-swap="textContent" hx-target="previous .link-count"></span>
      {% endfor %}
      {% for action in toolbarActions %}
        {% if action.name == 'export' and isToolbarActionAllowed('export') and data.rows %}
          <a href="/admin/{{ module.link }}/export-csv" class="btn btn-sm btn-primary me-2"><i class="bi {{ action.icon }} pe-1"></i> {{ action.label }}</a>
        {% endif %}
      {% endfor %}
      {% if filters.show %}
        <button class="btn btn-sm btn-primary me-2" hx-on::after-request="new bootstrap.Modal(document.getElementById('modal')).show()" hx-get="/admin/{{ module.link }}/modal/filter" hx-target=".modal-dialog" hx-select=".modal-content"><i class="bi bi-funnel pe-1"></i> Filter</button>
      {% endif %}
      {% if filters.showClear %}
          <button hx-post="/admin/{{ module.link }}/modal/filter" type="submit" class="btn btn-sm btn-danger me-2" name="filter_clear"><i class="bi bi-trash pe-1"></i> Clear Filter</button>
      {% endif %}
    </form>
    {% if tableActions|length > 0 %}
    <div id="bulk-actions" class="d-flex align-items-center ms-auto" style="display: none !important;">
      <span id="bulk-count" class="text-muted small me-2"></span>
      <select name="table_action" class="form-select form-select-sm me-1" id="table-action" disabled>
        <option disabled selected>Action</option>
        {% for action in tableActions %}
        <option value="{{ action.value }}">{{ action.label }}</option>
        {% endfor %}
      </select>
      <button hx-post="/admin/{{ module.link }}/table-action" hx-include="#table-action, .checkbox-selection, [name='csrf_token']" hx-confirm="Are you sure you want to apply this action?" hx-select="#module" hx-target="#module" hx-swap="outerHTML" type="button" class="btn btn-sm btn-primary" id="table-action-submit" disabled>Apply</button>
    </div>
    {% endif %}
  </div>
  <div class="table-responsive p-2">
    {% if data.rows|length > 0 %}
      <form>
      {{ csrf()|raw }}
      <table class="table table-hover table m-0">
        <thead>
          <tr>
            {% if tableActions|length > 0 %}
            <th class="checkbox-cell">
              <input id="select-all" onClick="selectAllToggle(event)" type="checkbox" />
            </th>
            {% endif %}
            {% for column,title in headers %}
            <th hx-get="/admin/{{ module.link }}/sort/{{ loop.index0 }}" hx-target="#table" hx-select="#table" hx-swap="outerHTML" class="pointer {% if column == filters.orderBy %}active {% if filters.sort == 'ASC' %}asc{% else %}desc{% endif %}{% endif %}" nowrap>{{ title }}</th>
            {% endfor %}
            {% if rowActions|length > 0 %}
            <th class="text-end">Actions</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for row in data.rows %}
          <tr>
            {% if tableActions|length > 0 %}
              <td class="checkbox-cell">
                <input type="checkbox" name="table_selection[]" onChange="checkEnabledMultiAction(event)" id="select_{{ row.id }}" class="checkbox-selection" value="{{ row.id }}" />
              </td>
            {% endif %}
            {% for key,value in row %}
              <td>{{ format(key, value)|raw }}</td>
            {% endfor %}
            {% if rowActions|length > 0 %}
              <td id="row-actions">
                <div class="d-flex justify-content-end">
                  {% for action in rowActions %}
                    {% if action.name == 'show' and hasShow(row.id) %}
                      <button class="btn btn-sm" hx-on::after-request="new bootstrap.Modal(document.getElementById('modal')).show()" hx-get="/admin/{{ module.link }}/modal/{{ row.id }}" hx-target=".modal-dialog" hx-select=".modal-content"><i class="bi {{ action.icon }}"></i></button>
                    {% elseif action.name == 'edit' and hasEdit(row.id) %}
                      <button class="btn btn-sm ms-1" hx-on::after-request="new bootstrap.Modal(document.getElementById('modal')).show()" hx-get="/admin/{{ module.link }}/modal/{{ row.id }}/edit" hx-target=".modal-dialog" hx-select=".modal-content"><i class="bi {{ action.icon }}"></i></button>
                    {% elseif action.name == 'delete' and hasDelete(row.id) %}
                      <button class="btn btn-sm ms-1" hx-confirm="{{ action.confirm }}" hx-post="/admin/{{ module.link }}/{{ row.id }}/destroy"><i class="bi {{ action.icon }}"></i></button>
                    {% endif %}
                  {% endfor %}
                </div>
              </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
        <caption>
          {{ caption }}
        </caption>
      </table>
      </form>
    {% else %}
      <div class="text-center p-1">
          <strong>No data available</strong>
      </div>
    {% endif %}
  </div>
  {% if pagination.totalPages > 1 or pagination.totalRows > 10 %}
    <div id="pagination-controls" class="d-flex flex-column flex-sm-row justify-content-between align-items-center gap-2 mt-3 px-2">
      <div class="d-flex align-items-center gap-2 small text-muted order-2 order-sm-1">
        <span>Show</span>
        <select
          class="form-select form-select-sm"
          style="width: auto;"
          hx-target="#module"
          hx-select="#module"
          hx-swap="outerHTML"
          onchange="htmx.ajax('GET', '/admin/{{ module.link }}/per-page/' + this.value, {target: '#module', select: '#module', swap: 'outerHTML'})">
          {% for opt in [10, 25, 50, 100] %}
            <option value="{{ opt }}" {% if pagination.perPage == opt %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
        <span>per page</span>
      </div>
      {% if pagination.totalPages > 1 %}
      <nav id="pagination" class="order-1 order-sm-2" hx-boost="true" hx-target="#table" hx-select="#table" hx-swap="outerHTML">
        <ul class="pagination pagination-sm mb-0">
          {% if pagination.page != 1 and pagination.page > pagination.links %}
          <li class="page-item">
            <a class="page-link" href="/admin/{{ module.link }}/page/1">
              <span><i class="bi bi-chevron-double-left"></i></span>
            </a>
          </li>
          <li class="page-item {% if pagination.page - 1 <= 0 %}disabled{% endif %}">
            <a class="page-link" href="/admin/{{ module.link }}/page/{{ pagination.page - 1}}">
              <span><i class="bi bi-chevron-left"></i></span>
            </a>
          </li>
          {% endif %}
          {% for i in pagination.page - pagination.links..pagination.page - 1 %}
            {% if i >= 1 %}
            <li class="page-item">
              <a class="page-link" href="/admin/{{ module.link }}/page/{{ i }}">{{ i }}</a>
            </li>
            {% endif %}
          {% endfor %}
          <li class="page-item active">
            <a class="page-link" href="/admin/{{ module.link }}/page/{{ pagination.page }}">{{ pagination.page }}</a>
          </li>
          {% for i in pagination.page + 1..pagination.page + pagination.links %}
            {% if i <= pagination.totalPages %}
            <li class="page-item">
              <a class="page-link" href="/admin/{{ module.link }}/page/{{ i }}">{{ i }}</a>
            </li>
            {% endif %}
          {% endfor %}
          {% if pagination.page != pagination.totalPages and pagination.page < pagination.totalPages - pagination.paginationLinks %}
          <li class="page-item">
            <a class="page-link {% if pagination.page + 1 >= pagination.totalPages %}disabled{% endif %}" href="/admin/{{ module.link }}/page/{{ pagination.page + 1 }}">
              <span><i class="bi bi-chevron-right"></i></span>
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="/admin/{{ module.link }}/page/{{ pagination.totalPages }}">
              <span><i class="bi bi-chevron-double-right"></i></span>
            </a>
          </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}
    </div>
  {% endif %}
  </div>
</div>
<script>
  var selectAllToggle = (e) => {
    const state = e.currentTarget.checked;
    const checkboxes = document.querySelectorAll(".checkbox-selection");
    checkboxes.forEach((checkbox) => {
        checkbox.checked = state;
    });
    updateBulkActions();
  }
  var checkEnabledMultiAction = (e) => {
    const checkboxes = document.querySelectorAll(".checkbox-selection");
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    document.getElementById("select-all").checked = allChecked;
    updateBulkActions();
  }
  var updateBulkActions = () => {
    const bulkActions = document.getElementById("bulk-actions");
    if (!bulkActions) return;
    const checked = document.querySelectorAll(".checkbox-selection:checked");
    const count = checked.length;
    const actionSelect = document.getElementById("table-action");
    const actionSubmit = document.getElementById("table-action-submit");
    const bulkCount = document.getElementById("bulk-count");
    if (count > 0) {
      bulkActions.style.display = 'flex';
      bulkActions.style.removeProperty('display');
      actionSelect.disabled = false;
      actionSubmit.disabled = false;
      bulkCount.textContent = count + ' selected';
    } else {
      bulkActions.style.setProperty('display', 'none', 'important');
      actionSelect.disabled = true;
      actionSubmit.disabled = true;
      bulkCount.textContent = '';
    }
  }
</script>
